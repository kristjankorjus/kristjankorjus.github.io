<html>
<header>
	<title>Javascript moment</title>
	<style>
		img {width: 100%;}
	</style>
	<script>

		function sleep(ms) {
	  return new Promise(resolve => setTimeout(resolve, ms));
		}

		function getURLParameter(name) {
			return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
		}

		function myButton() {
			window.history.replaceState( {} , 'foo', window.location.pathname + "?robot=" + document.getElementById('robot').value + "&ts=" + document.getElementById('timestamp').value + "&num_steps=" + document.getElementById('num_steps').value);
			myFunction();
		}

		function timeButton(evt) {
			var new_time = parseFloat(document.getElementById('timestamp').value) + evt.target.time_diff;
			window.history.replaceState( {} , 'foo', window.location.pathname + "?robot=" + document.getElementById('robot').value + "&ts=" +  String(new_time) + "&num_steps=" + document.getElementById('num_steps').value);
			myFunction();
		}


		async function myFunction() {
			var cameras = ["back_camera_left", "left_stereo-left", "front_camera", "right_stereo-left", "back_camera_right"];

			url_robot = getURLParameter('robot');
			url_ts = getURLParameter('ts');
			url_num_steps = getURLParameter('num_steps');

			var num_steps = (url_num_steps) ? url_num_steps : 3;
			var robot = (url_robot) ? url_robot:"6D101";
			var timestamp = (url_ts) ? url_ts:"1504171120.9728584";


			document.getElementById('num_steps').value = num_steps;
			document.getElementById('robot').value = robot;
			document.getElementById('timestamp').value = timestamp;

			document.getElementById("moment_link").innerHTML = "https://panel.starship.xyz/devel/moment/" + robot + "/" + timestamp;
			document.getElementById("moment_link").href = "https://panel.starship.xyz/devel/moment/" + robot + "/" + timestamp;

			var num_steps = document.getElementById('num_steps').value;
			var times = [];
			var delta = 0.25;
			var num_steps_one_side = Math.floor(num_steps / 2);

			document.getElementById("plus-step").innerHTML = "+" + num_steps + " steps";
			document.getElementById("minus-step").innerHTML = "-" + num_steps + " steps";
			document.getElementById("plus-step").time_diff = delta * num_steps;
			document.getElementById("minus-step").time_diff = -delta * num_steps;
			document.getElementById("plus-step").addEventListener("click", timeButton);
			document.getElementById("minus-step").addEventListener("click", timeButton);

			// Calculate timestamps
			for(var i=0; i<num_steps; i++) {
				times.push(- num_steps_one_side * delta + i * delta);
			}

			// Empty the table
			var table = document.getElementById("table-images");
			table.remove();
			table = document.createElement("table");
			table.id = "table-images";
			document.getElementById("table-div").appendChild(table);

			var count = 0;
			for (i = 0; i < num_steps; i++) {
				var url_beg = "https://panel.starship.xyz/data/image/ts/" + robot + "/" + String(parseFloat(timestamp) + times[i]) + "/";
				var row = document.createElement("tr");
				table.appendChild(row);

				for (j = 0; j < cameras.length; j++) {
					console.log("sleeping");
					console.log("slept");
					cell = document.createElement("th");
					cell_img = document.createElement("img");
					cell_img.src = url_beg + cameras[j];
					cell.appendChild(cell_img);
					row.appendChild(cell);
					count = count + 1;

					if(i == Math.floor(num_steps / 2)) {
						cell_img.style = "outline: 3px red solid;";
					}
				}
				await sleep(500);
			}
		}
	</script>
</header>

<body onload="myFunction();">
Robot: <input type="text" id="robot">
Timestamp: <input type="text" id="timestamp">
Number of steps: <input type="number" id="num_steps" style="width: 40px;">
<button id="go" onclick="myButton()">ok</button>
<button id="minus-step">-1 step</button>
<button id="plus-step">+1 step</button>
<a id="moment_link" href="" target="_blank"> Hello World!</a>
<br>

<script>
	document.getElementById("timestamp").addEventListener("keyup", function(event) {
		event.preventDefault();
		if (event.keyCode === 13) {
			document.getElementById("go").click();
		}
	});
</script>

<script>
	document.body.addEventListener("keyup", function(event) {
		event.preventDefault();
		if (event.keyCode === 78) {  // 'n'
			document.getElementById("plus-step").click();
		} else if (event.keyCode === 80) {  // 'p'
			document.getElementById("minus-step").click();
		}
	});
</script>


<div id="table-div">
<table id="table-images" style="width:100%;">

</table>
</div>

</body>
</html>
