<html>
<header>
	<title>Javascript moment</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<style> img {width: 100%;} </style>
	<script>

		function sleep(ms) {
			return new Promise(resolve => setTimeout(resolve, ms));
		}

		function getURLParameter(name) {
			return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
		}

		function goButton() {
			window.history.replaceState( {} , 'foo', window.location.pathname + "?robot=" + $("#robot").val() + "&ts=" + $("#timestamp").val() + "&num_secs=" + $("#num_secs").val());
			myFunction();
		}

		function timeButton(evt) {
			var new_time = parseFloat($("#timestamp").val()) + parseFloat($(evt.target).attr('time_diff'));
			console.log(new_time)
			window.history.replaceState( {} , 'foo', window.location.pathname + "?robot=" + $("#robot").val() + "&ts=" +  String(new_time) + "&num_secs=" + $("#num_secs").val());
			myFunction();
		}

		function getClosestTimestamp(timestamp, timestamps) {
			var closest_diff = 1e30;
			timestamps.forEach((i_timestamp) => {
				const diff = Math.abs(timestamp - i_timestamp);
				if (diff < closest_diff) {
					closest_timestamp = i_timestamp;
					closest_diff = diff;
				}
			})
			return closest_timestamp;
		}

		async function myFunction() {

			var cameras = ["left_stereo-left", "front_camera", "right_stereo-left"];

			url_robot = getURLParameter('robot');
			url_ts = getURLParameter('ts');
			url_num_secs = getURLParameter('num_secs');

			var num_secs = (url_num_secs) ? url_num_secs : 3;
			var robot = (url_robot) ? url_robot:"6D101";
			var timestamp = (url_ts) ? url_ts:"1504171120.9728584";


			$("#num_secs").val(num_secs);
			$("#robot").val(robot);
			$("#timestamp").val(timestamp);

			// https://local.starship.co:3001/data/image/frames/6E18/1517224621.295/20/front_camera

			// Empty the table
			var $table = $("#table-images");
			$table.empty();

			//$.get('https://data.starship.xyz/data/image/frames/6E18/1517224621.295/'+num_secs+'/front_camera', function(results){
			$.get('https://local.starship.co:3001/data/image/frames/'+robot+'/'+timestamp+'/'+num_secs+'/front_camera', function(results){
				$("#moment_link").attr('href', "https://panel.starship.xyz/devel/moment/" + robot + "/" + timestamp).text("https://panel.starship.xyz/devel/moment/" + robot + "/" + timestamp);

				$("#plus-step").text("+" + num_secs + " secs");
				$("#minus-step").text("-" + num_secs + " secs");
				$("#plus-step").attr('time_diff', num_secs);
				$("#minus-step").attr('time_diff', num_secs);

				var closest_timestamp = getClosestTimestamp(timestamp, results.data.timestamps);

				results.data.timestamps.forEach(function(timestamp){

					var url_beg = "https://panel.starship.xyz/data/image/ts/" + robot + "/" + timestamp + "/";
					var $row = $("<tr/>");

					cameras.forEach(function(camera){
						var $cell = $('<td><img src="' + url_beg + camera + '"/></td>');
						$row.append($cell);
					});
					if (timestamp === closest_timestamp) {
						$row.find('img').css("outline", "3px red solid");
					}
					$table.append($row);
				});

			}, 'json');

		}
	</script>
</header>

<body onload="myFunction();">
Robot: <input type="text" id="robot">
Timestamp: <input type="text" id="timestamp">
Number of steps: <input type="number" id="num_secs" style="width: 40px;">
<button id="go">ok</button>
<button id="minus-step">-1 step</button>
<button id="plus-step">+1 step</button>
<a id="moment_link" href="" target="_blank"> Hello World!</a>
<br>

<script>
	$("#timestamp").on("keyup", function(event) {
		event.preventDefault();
		if (event.keyCode === 13) {
			$("#go").click();
		}
	});
</script>

<script>
	$(document).on("keyup", function(event) {
		event.preventDefault();
		if (event.keyCode === 78) {  // 'n'
			$("#plus-step").click();
		} else if (event.keyCode === 80) {  // 'p'
			$("#minus-step").click();
		}
	});
	$("#plus-step").on("click", timeButton);
	$("#minus-step").on("click", timeButton);
	$("#go").on("click", goButton);

</script>


<div id="table-div">
<table id="table-images" style="width:100%;">

</table>
</div>

</body>
</html>
